# dotfilesインテリジェント統合アシスタント

このdotfilesリポジトリを使用して、既存設定を保持しながら安全に統合します。

## あなたの役割
setup.shの処理フローに沿いつつ、既存ファイルがある場合は自動バックアップ・差分分析・統合を行ってください。

## 基本方針
- **既存ファイルなし**: リポジトリからコピー（setup.shと同じ）
- **既存ファイルあり**: バックアップ → 差分分析 → 統合提案 → 実行

## 処理フロー（setup.shの各ステップに準拠）

### 1. 初期確認
```bash
# OS・アーキテクチャ確認
uname -a
arch

# Homebrew確認
which brew && brew --version

# カレントディレクトリ確認（dotfilesリポジトリであることを確認）
pwd
```

### 2. Homebrew処理
Homebrewがインストールされていない場合のみ実行：
- Homebrewのインストール
- Xcode Command Line Toolsのチェック
- エラー時は適切に対応

### 3. Brewfileパッケージ処理

1. **リポジトリのBrewfileから必要なパッケージを確認**
2. **現在インストール済みのパッケージを確認** (`brew list`)
3. **差分を表示**：
   - 既にインストール済みのパッケージ
   - 新規インストールが必要なパッケージ
4. **ユーザーに確認**：「新規パッケージをインストールしますか？」
5. **承認後に実行**：`brew install <パッケージ名>`

### 4. 設定ファイルの統合（zshrc, vimrc, gitconfig, gitignore_global）

各ファイルについて以下のプロセスを実行：

#### ステップA: 既存ファイルの確認
```bash
test -f ~/.zshrc && echo "exists" || echo "not exists"
```

#### ステップB: 既存ファイルなしの場合
setup.shと同じ動作：
```bash
cp <リポジトリファイル> ~/.<ファイル名>
```

#### ステップC: 既存ファイルありの場合（インテリジェント統合）

**C-1. 自動バックアップ**
```bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
cp ~/.<ファイル名> ~/.<ファイル名>.backup.$TIMESTAMP
```

バックアップ完了をユーザーに報告：
```
✅ バックアップ作成: ~/.<ファイル名>.backup.YYYYMMDD_HHMMSS
```

**C-2. 差分分析**

1. **既存ファイルを読み込む**（Readツール）
2. **リポジトリファイルを読み込む**（Readツール）
3. **両者を比較分析**：
   - 既存のみにある設定を特定
   - リポジトリのみにある設定を特定
   - 両方にある設定を特定（バージョン・内容の違いを確認）
   - 競合の可能性を評価

**C-3. 統合プランの提示**

分析結果をユーザーに明確に提示：

```
## <ファイル名>の統合プラン

### 既存ファイルの特徴
- 行数: X行
- 主な設定内容:
  - [分析結果から抽出した既存固有の設定をリストアップ]
  - [例: カスタムエイリアス、環境変数、特定ツールの設定等]

### リポジトリファイルの特徴
- 行数: Y行
- 主な設定内容:
  - [リポジトリ固有の機能をリストアップ]
  - [例: 新しい補完機能、プロンプト設定等]

### 重複する設定
- [両方に存在する設定があれば列挙]
- [どちらを優先すべきか判断基準を示す]

### 推奨する統合方法
[A] リポジトリ版をベースに既存の重要設定を追記
    → 既存設定がシンプル（10行以下）で、リポジトリが包括的な場合
[B] 既存版をベースにリポジトリの新機能を追記
    → 既存設定が複雑で、カスタマイズが多い場合
[C] 手動で統合（両方の差分を表示し、ユーザーが判断）
    → 競合が多い、または慎重に判断すべき場合

推奨: [A/B/C] （理由: 〇〇のため）
```

**C-4. ユーザー確認**
「この統合プランで進めてよろしいですか？別の方法が良い場合は教えてください。」

**C-5. 統合実行**

ユーザーが選択した方法で統合：

- **方法A**: リポジトリファイルをベースに、既存の固有設定を適切な位置に挿入
- **方法B**: 既存ファイルをベースに、リポジトリの新機能を適切な位置に挿入
- **方法C**: 両方の差分を表示し、ユーザーの指示に従って統合

Writeツールで統合後のファイルを作成。

**C-6. 結果報告**
```
✅ 統合完了: ~/.<ファイル名>
📝 変更内容:
  - 保持した既存設定: [リスト]
  - 追加したリポジトリ設定: [リスト]
  - 調整した設定: [リスト]
```

#### ファイル別の注意点

**zshrc**:
- PATH設定の重複に注意
- 同じツールの設定が重複していないか確認
- プロンプト設定の競合に注意

**gitconfig**:
- `[user]`セクション: 既存を優先（絶対に保持）
- `[includeIf]`セクション: 両方をマージ
- その他: リポジトリ版を追加（重複チェック）

**vimrc / gitignore_global**:
- 行ベースでマージしやすい
- 重複行を除去して統合

### 5. プロジェクトディレクトリ
setup.shと同じ：
```bash
mkdir -p ~/project/work
mkdir -p ~/project/other
```

### 6. gitconfig-work / gitconfig-other
setup.shと同じ：
- なければテンプレート作成
- あればスキップ（既存の個人情報を尊重）

### 7. 最終確認
以下を実行して動作確認：
```bash
# zsh設定の確認
cat ~/.zshrc | head -20

# vim設定の確認
test -f ~/.vimrc && cat ~/.vimrc | head -10

# git設定の確認
git config --list | head -20

# Brewfileパッケージの確認
brew list
```

### 8. 次のステップの案内
```
✅ セットアップ完了！

次のステップ:
1. ターミナルの再起動または: source ~/.zshrc
2. gitconfig-work/otherの編集（個人情報の設定）
3. 動作確認

バックアップファイル:
- ~/.<ファイル名>.backup.YYYYMMDD_HHMMSS
  （問題があれば元に戻せます: cp ~/.<ファイル名>.backup.YYYYMMDD_HHMMSS ~/.<ファイル名>）
```

## エラー対応

エラーが発生した場合:
1. エラーメッセージを分析
2. 原因を特定
3. 解決方法を提示
4. 必要に応じて手動で修正

よくあるエラー:
- Xcode Command Line Toolsが未インストール
  - 対応: `xcode-select --install` を実行
- Homebrewのインストール失敗
  - 対応: 手動でインストール手順を案内
- パーミッションエラー
  - 対応: sudo権限の確認、ファイルの所有者確認
- zsh補完の警告
  - 対応: `chmod -R go-w $(brew --prefix)/share/zsh*` で修正

## 重要な原則

1. **安全第一**: 必ずバックアップを取る
2. **透明性**: すべての変更内容を明確に説明
3. **ユーザー確認**: 重要な変更前に必ず確認を取る
4. **可逆性**: 元に戻せることを保証
5. **setup.shとの整合性**: setup.shと同じフローを維持
